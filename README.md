# DBTest - Утилита для автоматизированного стресс- и нагрузочного тестирования

# ТЕХНОЛОГИЯ ЭКСПЛУАТАЦИИ

# 1.	Общие сведения

Пользователь может воспользоваться созданным ПС как для создания и инициализации БД с нужными характеристиками, так и для тестирования существующей БД. На рисунке 1 представлены возможные сценарии пользовательского взаимодействия ПС.

![Сценарии пользовательского взаимодействия](https://user-images.githubusercontent.com/33948411/121100414-21c43880-c83d-11eb-876b-633ccd9bec5d.png)
Рисунок 1 – Сценарии пользовательского взаимодействия<br /><br />

# 2.	Подключение к базе данных

После запуска ПС перед пользователем откроется окно, представленное на рисунке 2. Пользователю необходимо добавить в список драйвер для СУБД, к которой производится подключение, при этом ответственность за получение корректного драйвера, соответствующего стандарту JDBC 4.0 и выше возлагается на пользователя. Находясь на вкладке «Driver», пользователь должен выбрать из списка добавленный драйвер. Затем на вкладке «Connection» пользователь должен указать имя хоста, порт, имя пользователя, пароль, имя базы данных и протокол (название протокола необходимо уточнить у поставщика СУБД).
После подключения у пользователя появится возможность перейти к созданию параметризованной БД, либо тестированию существующей БД.

<img width="447" alt="image" src="https://user-images.githubusercontent.com/33948411/121098128-8f219a80-c838-11eb-981d-1b25934797ca.png">
Рисунок 2 – Список пользовательских драйверов<br /><br />

# 3.	Создание базы данных

Подключившись к БД и кликнув по левой навигационной панели на пункте «Database», пользователь увидит окно, представленное на рисунке 3, в котором он сможет создать БД с нужными ему характеристиками и заполнить ее.
Прежде всего необходимо задать имя создаваемой БД. Затем пользователю нужно выбрать количество таблиц, которое он хочет видеть в созданной БД. Также ему нужно заполнить поля «Linked Tables» и «Indexes per Table» обозначающие процент связанных внешним ключом таблиц от общего их количества и процент индексных полей в каждой таблице соответственно. Такие параметры как среднее количество полей и среднее и среднее количество записей («Avg. Number of Columns» и «Avg. Number of Records») определяются для каждой таблицы по нормальному распределению, где пользователь задает среднее и отклонение.
Для выполнения тестирования по созданной таким образом БД пользователь должен используя навигационную панель вновь перейти к окну «Connection», где должен подключиться к только что созданной БД. В противном случае, дальнейшее тестирование будет проводиться по той БД, к которой было выполнено соединение.

<img width="458" alt="image" src="https://user-images.githubusercontent.com/33948411/121098196-b1b3b380-c838-11eb-8b6d-fa96afbab1c5.png">
Рисунок 3 – Окно инициализации базы данных<br /><br />

# 4.	Конфигурация тестирования СУБД

Пользователь, путем нажатия на кнопку «Load test», переходит к окну конфигурирования параметров тестирования СУБД (см. рисунок 4). Перед запуском тестирования пользователю необходимо задать определенный набор параметров, а именно:
<ul>
<li>местоположение директории с отчетом (поле Path to Dashboard), формируемым по завершении тестирования. Указываемая пользователем директория должна быть пустой;
<li>местоположение файла с логами (поле Path to .log), в который будут записываться логи по ходу тестирования;
<li>местоположение файла с результатами тестирования (поле Path to .jtl). Файл с результатами тестирования – это файл, содержащий показатели тестирования в текстовой форме и используемый в дальнейшем для формирования графического отчета о тестировании;
<li>собираемые показатели тестирования (кнопка Configure). Выбранные пользователем в окне, представленном на рисунке 5, показатели будут записаны в файл с результатами тестирования и могут быть использованы для дальнейшей обработки другими ПС;
<li>количество виртуальных пользователей (поле Number of Threads), выполняющих план тестирования. Виртуальные пользователи реализованы в системе посредством работающих параллельно потоков;
<li>период времени, в течении которого создаются виртуальные пользователи (поле Ramp-up period (seconds)), измеряемый в секундах. Пользователи внутри данного периода создаются с равным интервалом;
<li>количество циклов тестирования (поле Loop Count), определяющее сколько раз план тестирования будет выполнен каждым отдельным пользователем;
<li>перечень удаленных хостов, в случае распределенного тестирования.
</ul>

<img width="443" alt="image" src="https://user-images.githubusercontent.com/33948411/121098266-d27c0900-c838-11eb-8839-985a65fd8421.png">
Рисунок 4 – Окно конфигурации тестирования<br /><br />


<img width="427" alt="image" src="https://user-images.githubusercontent.com/33948411/121098317-efb0d780-c838-11eb-90f6-c3ef491c0392.png">
Рисунок 5 – Окно конфигурирования показателей для сохранения<br /><br />


Для выполнения распределенного тестирования СУБД пользователю необходимо самостоятельно определенным образом подготовить подчиненные хосты. Корректная работа распределенного тестирования обеспечивается при выполнении следующих условий на подчиненном хосте:
<ul>
<li>брандмауэр для локальной подсети отключен;
<li>развернута JRE  11;
<li>развернута Apache JMeter 5.4.1;
<li>в домашней директории Apache JMeter, в каталоге cp находится необходимый для подключения к СУБД драйвер;
<li>в домашней директории Apache JMeter, в каталоге bin должен находиться валидный SSL ключ, сгенерированный на управляющем хосте;
<li>запущен Apache JMeter в режиме сервера с указанием адреса и порта подчиненного хоста, например как «jmeter-server -Djava.rmi.server.hostname=10.211.55.5 -Dserver_port=5000».
</ul>
Сконфигурировав параметры тестирования, пользователь сможет приступить к тестированию, но сперва ему необходимо создать план тестирования, о чем пойдет речь в следующем разделе.

# 5.	Создание плана тестирования

Находясь в окне «Load test» и щелкнув по вкладке «Query», пользователь получит доступ к формированию очереди запросов, составляющих план тестирования (см. рисунок 6).

<img width="425" alt="image" src="https://user-images.githubusercontent.com/33948411/121098479-46b6ac80-c839-11eb-9e62-31465557b2fd.png">
Рисунок 6 – Окно формирования очереди запросов в своем начальном состоянии<br /><br />

В данном окне пользователь добавляет различные виды запросов в очередь путем нажатия на кнопку «Add …» (см. рисунок 7). 
 
<img width="167" alt="image" src="https://user-images.githubusercontent.com/33948411/121098517-57672280-c839-11eb-95aa-8bc4352fc0b0.png">
Рисунок 7 – Варианты добавляемых запросов<br /><br />

После клика по кнопке «Add SELECT» перед пользователем появится форма динамического создания запроса типа SELECT (см. рисунок 8).

<img width="308" alt="image" src="https://user-images.githubusercontent.com/33948411/121098546-6e0d7980-c839-11eb-8ad5-d3235cbc540f.png">
Рисунок 8 – Форма динамического создания запроса типа SELECT<br /><br />

Перемещая соответствующие слайдеры, пользователь может изменять соответствующим образом текст SQL запроса корректируя в нем количество группирующих, агрегирующих и фильтрующих его составляющих (см. рисунок 9). 
 
<img width="389" alt="image" src="https://user-images.githubusercontent.com/33948411/121098567-7a91d200-c839-11eb-9726-6326835c2051.png">
Рисунок 9 – Добавленный в очередь SQL запрос<br /><br />

Для других типов запросов (INSERT, UPDATE, DELETE) форма создания запроса выглядит гораздо проще (см. рисунок 10).

<img width="328" alt="image" src="https://user-images.githubusercontent.com/33948411/121098586-84b3d080-c839-11eb-97ed-b65140ec70ca.png">
Рисунок 10 – Форма создания запросов типов INSERT, UPDATE, DELETE<br /><br />

Динамическое формирование запроса предусмотрено только для запросов типа SELECT по следующим причинам:
<ul>
<li>запросы, изменяющие содержимое таблиц, требуют для своего динамического формирования чрезвычайно глубокого анализа метаданных и содержимого таблиц (полный перебор всех записей) для обеспечения отсутствия нарушения различных ограничений в БД (явных и косвенных), что сильно завязано на специфичных для СУБД функциях и, как следствие противоречит цели поддержке максимально возможного набора СУБД, а также негативно сказывается на времени выполнения;
<li>мультипликативный эффект по отношению к предыдущему замечанию несет тот факт, что для обеспечения соблюдения ограничений в БД при динамическом формировании запросов типов INSERT, UPDATE, DELETE подразумевает не только анализ состояния БД до выполнения тестового плана, но и во время его выполнения после отправки каждого запроса, так как каждый запрос указанных типов потенциально может сделать последующие запросы некорректными. Попытка решить данную проблему привела бы к разработке полноценной модели функционирования СУБД, а разработка в данном направлении – к настолько сильной загрузке системы, выполняющей тестирование, что она бы не смогла в должной степени быстро создавать и обрабатывать виртуальных пользователей; 
<li>запросы типов INSERT, UPDATE, DELETE имеют линейные зависимости времени выполнения от сложности и не представляют особого интереса.
Ответственность за корректное формирование запросов типов INSERT, UPDATE, DELETE возлагается на пользователя.
Для всех типов запросов присутствует возможность ручного формирования запросов, что позволяет ему использовать в тестировании заранее заготовленные запросы (при этом важно выбрать правильный тип запроса при его добавлении в очередь).
Для запуска тестирования пользователю необходимо нажать на кнопку «Test». В результате перед ним появится окно, отображающее процесс тестирования (см. рисунок 11).
</ul>
 
<img width="426" alt="image" src="https://user-images.githubusercontent.com/33948411/121098618-98f7cd80-c839-11eb-8887-ea59b5631e6f.png">
Рисунок 11 – Окно, отображающее процесс тестирования<br /><br />

По завершении тестирования, пользователь получит возможность просмотреть сгенерированный отчет.

# 6.	Отчет о тестировании

Полученный в результате тестирования отчет предоставляет следующие метрики:
<ul>
<li>таблица APDEX (Application Performance Index), которая вычисляет APDEX для каждой транзакции на основе настраиваемых значений для допустимых и удовлетворяемых пороговых значений;
<li>сводный график запроса, показывающий процент успешных и неудачных запросов;
<li>таблица статистики, содержащая в одной таблице сводку всех показателей для каждой транзакции, включая три процентиля;
<li>таблица ошибок, содержащая сводку всех ошибок и их долю в общем количестве запросов;
<li>время отклика с течением времени;
<li>процентили времени отклика с течением времени;
<li>активные потоки с течением времени;
<li>пропускная способность в байтах с течением времени;
<li>задержки с течением времени;
<li>время подключения;
<li>транзакции в секунду.
</ul>

